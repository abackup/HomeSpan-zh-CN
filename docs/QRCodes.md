<!-- 原文时间：2023.3.19，翻译时间：2023.9.28，校对时间：2024.7.12 -->

# 与二维码配对

使用 8 位*设置代码*配对 HomeKit 设备需要你：

* 从“家庭”应用在本地网络上找到的未配对 HomeKit 设备列表中选择要配对的设备
* 将该设备的*设置代码*输入到“家庭”应用中。

上述步骤的顺序取决于你是手动键入*设置代码*，还是从打印的标签上扫描它。

相比之下，将 HomeKit 设备与**二维码**配对只需要扫描二维码。你无需识别要配对的设备。“家庭”应用将改为在你的本地网络上搜索它，如果找到则会自动与之配对。

这是可能的，因为二维码包含一个 4 字符的*设置 ID*，它对于与二维码关联的设备是唯一的。二维码还嵌入了有关设备的其他配对信息，例如其类别（例如灯、风扇、门）及其 8 位*设置代码*。

HomeSpan 支持与二维码配对，并使用 "HSPN" 作为其默认*设置 ID*。但是，如果你打算将多个设备与二维码配对，则需要确保每个设备都有一个唯一的*设置 ID*。你可以通过以下两种方式之一更改设备上的*设置 ID*：

* 通过在 HomeSpan [命令行界面](./CLI.md) 中键入 "O \<code\>" 将新代码存储在设备 NVS 中；或者
* 使用 `homeSpan.setQRID(const char *ID)` 方法直接在你的草图中指定 QR *设置 ID*。
  
优先顺序如下：如果你的草图包含对 `homeSpan.setQRID(const char *ID)` 的调用，则使用指定的 ID。如果没有，HomeSpan 将改为在 NVS 中搜索存储的*设置 ID*。如果未找到，HomeSpan 默认使用 "HSPN" 作为*设置 ID*。
  
请注意，如果你不打算将设备与二维码配对，则它们都可以保留默认的 "HSPN" *设置 ID*，因为此 ID 仅用于通过二维码启动配对过程并提供服务没有其他目的。

### 创建可扫描的二维码

就像你可以根据 HomeSpan 设备的*设置代码*创建自己的可扫描标签一样（请参阅 [用户指南](./UserGuide.md#创建可扫描的二维码), 你还可以创建自己的可扫描二维码来配对 HomeSpan 设备。也许最简单的方法是使用苹果公司的 HomeKit 二维码生成器，包括其 [HomeKit Accessory Simulator](https://developer.apple.com/documentation/homekit/testing_your_app_with_the_homekit_accessory_simulator ) 的附加组件 Xcode。

![二维码生成器](images/QRCode.png)

如上图，模拟器的二维码生成器需要输入以下字段：

* **版本**。始终将此设置为零，否则“家庭”应用将无法识别二维码。
* **预订的**。始终将此设置为零，否则“家庭”应用将无法识别二维码。
* **类别**。将此设置为与你的 HomeSpan 设备的类别相匹配（例如灯泡、风扇、门锁）。请注意，“家庭”应用仅在你首次扫描二维码时将其用于显示目的。“家庭”应用实际上不会检查二维码中列出的类别是否与你正在配对的设备的类别匹配。
* **设置标志**。这些标志提供有关 HomeKit 设备支持哪些配对方法的信息。HomeSpan 仅支持 IP 配对，因此你选中该框并将其他两个留空。但是，你检查哪个框（如果有）似乎并不重要，因为 家庭 应用似乎没有将此信息用于任何事情。
* **设置代码**。这是你使用 [命令行界面](./CLI.md) 为你的设备设置的 8 位*设置代码* 或 [HomeSpan 的 WiFi 设置网页](./UserGuide.md#设置-homespan-的-wifi-凭据和设置代码)。请注意，上面屏幕截图中显示的代码是 HomeSpan 使用的默认代码，如果你不设置自己的代码。
* **设置 ID**。这是你在草图中使用方法 `homeSpan.setQRID(const char *id)` 为 HomeSpan 设备设置的 4 字符 *设置 ID*。如果你未在草图中指定 QR 设置 ID，HomeSpan 将使用默认值 "HSPN"（如上例所示），除非你已通过 [CLI](CLI.md) 更新此设备的默认值使用 "Q" 命令。注意案例很重要！ HSPN 与 "HSPN" 不同。
* **设置有效负载**。这是由上述输入产生的输出，并且是由显示的二维码表示的文本。HomeKit 设备的设置有效负载 始终以 "X-HM://" 开头，后跟 9 个字母数字字符，并以纯文本形式的*设置 ID*结尾。如果你没有更改 HomeSpan 的默认*设置代码*或*设置 ID*，你可以通过使用“家庭”应用扫描此图形来配对你的设备。更简单的是直接从你的相机扫描它 - 你的 iPhone 会识别出这是一个 HomeKit 二维码并为你打开“家庭”应用。

你可能注意到二维码包含额外的图形，例如左上角的苹果 HomeKit 徽标。这纯粹是装饰性的，“家庭”应用不需要进行配对。同样，在右上角以大数字显示设备的 8 位*设置代码*也是一种装饰，不需要配对，但如果你在扫描二维码时遇到问题并想要手动输入*设置代码*进入“家庭”应用，它可能会很方便代码。

“家庭”应用实际扫描的完整图形的唯一部分是二维码本身，这意味着你可以使用任何允许你输入任意文本的通用二维码生成器创建与 HomeKit 兼容的二维码。你需要输入到此类二维码生成器的文本当然是设置有效负载。你可以遵循一种相对简单的算法来为你的每个 HomeSpan 设备生成正确的设置有效负载文本，但让 HomeSpan 为你执行此操作更容易。

这是因为每当你设置或更改*设置代码*时，HomeSpan 都会在 Arduino 串口监视器上自动显示 HomeSpan 设备所需的设置有效负载文本。**只需将串口监视器上显示的设置有效负载文本复制到通用二维码生成器中，viola — 你已经创建了一个可扫描的二维码，可用于配对 HomeSpan 设备。**

### 设置有效载荷算法（*可选阅读*）

HomeKit 设备的设置有效负载 始终以 "X-HM://" 开头，后跟 9 个 base-36 数字，用于编码设备的所有配对参数，并以纯文本形式的设备的 *设置 ID* 结尾。

> Base-36 数字使用字符 0-9 和 A-Z（仅限大写！）来表示数字 0-35，其方式与十六进制数字 0-9 和 A-F 表示数字 0-15 的方式相同。例如，十进制数 91 将表示为以 36 为底的 2S (91=2*36+19)

九个 base-36 数字应编码由以下数据元素组成的 45 位字（从最高有效位到最低有效位列出）：

* 位 45-43 - “版本”字段 (0-7)。始终设置为 0
* 位 42-39 - “保留”字段 (0-15)。始终设置为 0
* 位 38-31 - 设备的配件类别 (0-255)
* 位 30 - 始终设置为 0
* 位 29 - 如果设备支持 BLTE 配对，则设置为 1，否则设置为 0
* 位 28 - 如果设备支持 IP 配对设置为 1，否则设置为 0
* 位 27 - 如果设备支持 NFC 配对，则设置为 1，否则设置为 0
* 位 26-0 - 设备的 8 位*设置代码*（从 0-99999999）

结果必须是 9 位数字。如果小于，则用前导零填充。

---

[↩️](../README.md#resources) 返回欢迎页面
