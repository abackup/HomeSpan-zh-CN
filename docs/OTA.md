<!--  原文时间：2023.3.19，翻译时间：2024.5.13，校对时间：2024.7.12 -->

# 无线 (OTA) 更新

HomeSpan 支持无线 (OTA) 更新，它允许你直接从 Arduino IDE *无线*上传草图——无需串口连接。要为你的草图激活此功能，只需在调用 `homeSpan.begin()` 之前调用方法 `homeSpan.enableOTA()`。

在启用 OTA 的情况下运行 HomeSpan 草图时，设备显示为“网络”端口，可以在 Arduino IDE 的 *工具→端口* 菜单下选择该端口。选择后，IDE 将通过 WiFi 将所有上传内容定向到设备，而不是在串口端口上查找。请注意，即使你的设备仍连接到串口端口，你也可以通过 OTA 上传，但 Arduino IDE 目前不支持同时连接多个端口。如果你选择“网络”端口，IDE 将自动关闭串口监视器（如果它是打开的）。要通过“串口”端口恢复上传，只需从 Arduino IDE 的 *工具→端口* 菜单中选择该端口。无论你是否为草图启用了 OTA，始终可以通过串口端口上传。

默认情况下，每当你开始 OTA 上传时，HomeSpan 都需要使用密码。默认 OTA 密码为 "homespan-ota"。在你第一次尝试将草图上传到新连接的设备时，Arduino 会提示你输入此密码。但是，一旦输入特定设备的密码，只要 IDE 运行，Arduino IDE 就会将其保留在内存中，从而使你不必在每次通过 OTA 重新上传草图时再次输入密码。

你可以使用 "O" 命令从 [命令行界面](docs/CLI.md) 更改 HomeSpan 设备的密码。与设备的设置代码类似，HomeSpan 将你指定的 OTA 密码的不可恢复散列版本保存在非易失性存储 (NVS) 中。如果你忘记了你指定的密码，你需要使用 "O" 命令创建一个新密码，或者你可以通过使用 "E" 命令完全擦除 NVS 来恢复默认的 OTA 密码。

还可以通过调用 `homeSpan.enableOTA(const char *pwd)` 从草图中以编程方式更改密码。这不如使用上述方法设置密码安全，因为你的草图将包含纯文本版本，而不是散列版本或密码。请注意，以这种方式设置密码会导致 HomeSpan 忽略但不会更改你使用 "O" 命令保存在 NVS 中的任何密码。

> :exclamation: 虽然不推荐，但你可以在为你的草图启用 OTA 时覆盖密码要求，方法是将 *false* 作为启用方法的参数，如下所示： `homeSpan.enableOTA(false)`。谨慎使用！任何可以通过你的网络访问该设备的人现在都可以上传新草图。

请注意，为了使 OTA 正常运行，你的草图必须使用包含 OTA 分区的分区方案进行编译。分区方案位于 Arduino IDE 的 *工具→Partition Scheme* 菜单下。选择一个表明它支持 OTA 的方案。请注意，标记为“默认”的方案通常包括 OTA 分区。如果不确定，请尝试一下。HomeSpan 会通知你是否这样做。

这是因为如果已为该草图启用 OTA，HomeSpan 会检查该草图是否已使用 OTA 分区编译。如果 OTA 已启用，但 HomeSpan 未找到任何 OTA 分区，它将通过在 WiFi 连接建立后立即发送到串口监视器的警告消息指示它无法启动 OTA 服务器。否则，它会输出一条确认消息，表明 OTA 服务已成功启动。

### OTA 安全加载

HomeSpan 在使用 OTA 上传草图时包括两项额外的安全检查：

1. HomeSpan 检查以确保上传的新草图也是另一个 HomeSpan 草图。如果没有，HomeSpan 将拒绝新的草图，并在新草图上传后但在设备重新启动之前向 Arduino IDE 报告 OTA 错误。相反，HomeSpan 将关闭 OTA 连接并根据现有草图恢复正常操作，而无需重新启动。此安全检查的目的是防止你不小心将非 HomeSpan 草图上传到远程设备上，使你无法在不检索远程设备并通过串口端口连接到你的电脑的情况下重新上传正确的草图。

1. 通过 OTA 成功上传新的 HomeSpan 草图后，HomeSpan 将检查刚刚加载的新 HomeSpan 草图*也*已启用 OTA。此检查在使用新草图重新启动 HomeSpan 后进行。如果 HomeSpan 没有发现 OTA 启用，它会将当前分区标记为无效并重新启动设备，导致设备“回滚”到启用 OTA 的先前版本的草图。此安全检查的目的是确保你不使用 OTA 将新的 HomeSpan 草图上传到远程设备，但未能在新的 HomeSpan 草图中启用 OTA。如果你这样做，你将无法通过 OTA 进行任何进一步更新，而是需要检索远程设备并通过串口端口将其连接到你的电脑。

请注意，这些检查*仅*适用于通过 OTA 上传草图时。只要通过串口端口上传草图，它们就会被忽略。此外，虽然这些安全检查默认启用，但当你首次启用 OTA 时，可以通过将第二个（可选）参数设置为 *false* 来禁用它们： `homeSpan.enableOTA(..., false)`。有关详细信息，请参阅 [API 参考](docs/Reference.md)。

### OTA 提示和技巧

* HomeSpan 用于 OTA 的设备名称与你在调用 `homeSpan.begin()` 时分配的名称相同。如果你打算使用 OTA 维护多个设备，请使用 `homeSpan.begin()` 为它们指定不同的名称，以便在从 Arduino IDE 选择要连接的设备时区分它们。

* 使用 `homeSpan.setSketchVersion()` 方法为你的草图设置版本（有关详细信息，请参阅 [API 参考](docs/Reference.md)）。如果指定，HomeSpan 将包含草图版本作为其 HAP MDNS 广播的一部分。这允许你确定哪个版本的草图正在远程 HomeSpan 设备上运行，即使你无法将其插入串口端口以与 Arduino 串口监视器一起使用。除了草图版本，HomeSpan 还在其 MDNS 广播中包含其他有助于识别设备的字段：用于编译草图的 HomeSpan *library* 的版本号，该字段指示是否为草图，编译时使用的 Arduino-ESP32 库的版本号，以及板的类型（例如 *feather_esp32*）。

* 如果你使用 OTA 上传的草图没有按预期运行，你可以继续修改代码并重新上传。或者，你可以上传正常工作的早期版本。但是，上述安全加载功能无法防止存在重大运行时问题的 HomeSpan 草图，例如导致内核恐慌导致设备无休止的重启循环。如果发生这种情况，HomeSpan 将无法运行 OTA 服务器代码，并且*无法*进行进一步的 OTA 更新。相反，你必须通过串口端口连接设备才能上传新的工作草图。**因此，你应该始终在连接到你电脑的本地设备上对新草图进行全面测试*之前*，然后通过 OTA 将其上传到远程、难以访问的设备。**

* 请注意，尽管 ESP IDF 支持旨在解决上传错误后无休止重启问题的*自动*回滚，但此功能*未*在最新版本的 Arudino-ESP32 库中启用（本帖发布时库版本为 2.0.2）。

---

[↩️](../README.md#resources) 返回欢迎页面
